---
import Layout from "../../components/Layout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import { getCollection, render } from "astro:content";
import { business } from "../../data/business";
import { createArticleSchema, createBreadcrumbSchema } from "../../lib/schema";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const pageTitle = `${post.data.title} | ${business.name}`;
const pageDescription = post.data.description;
const canonicalUrl = `${business.siteUrl}/blog/${post.slug}`;

const breadcrumbItems = [
  { name: "Blog", href: "/blog" },
  { name: post.data.title, href: `/blog/${post.slug}` },
];

const structuredData = [
  createArticleSchema(post),
  createBreadcrumbSchema(breadcrumbItems),
];

function formatDate(date: Date): string {
  return date.toLocaleDateString("en-CA", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}
---

<Layout
  title={pageTitle}
  description={pageDescription}
  canonicalUrl={canonicalUrl}
  structuredData={structuredData}
  ogType="article"
  ogImage={post.data.image}
  article={{
    publishedTime: post.data.pubDate.toISOString(),
    modifiedTime: post.data.updatedDate?.toISOString(),
    author: post.data.author,
    tags: post.data.tags,
  }}
  headerVariant="simple"
  headerSubtitle="Blog"
  quoteHref="/#quote"
>
  <article class="section">
    <div class="mx-auto max-w-3xl px-5 sm:px-6">
      <Breadcrumbs items={breadcrumbItems} />

      <header class="mb-10 space-y-4">
        <div class="flex flex-wrap gap-2">
          {
            post.data.tags.map((tag) => (
              <span class="rounded-full border border-border bg-paper px-3 py-1 text-xs uppercase tracking-wider text-ink-soft">
                {tag}
              </span>
            ))
          }
        </div>
        <h1 class="text-3xl font-display font-semibold leading-tight text-ink sm:text-4xl lg:text-5xl">
          {post.data.title}
        </h1>
        <p class="text-base text-ink-soft sm:text-lg">
          {post.data.description}
        </p>
        <div class="flex items-center gap-4 text-sm text-ink-soft">
          <span>{post.data.author}</span>
          <span>•</span>
          <time datetime={post.data.pubDate.toISOString()}>
            {formatDate(post.data.pubDate)}
          </time>
          {
            post.data.updatedDate && (
              <>
                <span>•</span>
                <span>
                  Updated{" "}
                  <time datetime={post.data.updatedDate.toISOString()}>
                    {formatDate(post.data.updatedDate)}
                  </time>
                </span>
              </>
            )
          }
        </div>
      </header>

      {
        post.data.image && (
          <div class="mb-10 overflow-hidden rounded-2xl border border-border shadow-fine">
            <img
              src={post.data.image}
              alt={post.data.imageAlt || post.data.title}
              class="w-full object-cover"
              loading="eager"
            />
          </div>
        )
      }

      <div class="prose prose-ink max-w-none">
        <Content />
      </div>

      <!-- CTA at end of article -->
      <div class="mt-12 rounded-2xl border border-border bg-white/90 p-6 shadow-fine sm:p-8">
        <p class="section-kicker">Need help with your yard?</p>
        <h2 class="mb-2 text-2xl font-display font-semibold text-ink">
          Get a free quote today
        </h2>
        <p class="mb-4 text-sm text-ink-soft">
          Let us handle the hard work. Call or text for a same-day quote on lawn care and
          landscaping services across Vancouver Island.
        </p>
        <div class="flex flex-wrap gap-3">
          <a
            class="rounded-full bg-ink px-6 py-3 text-sm font-semibold text-paper hover:bg-ink/90"
            href={`tel:${business.phoneTel}`}
          >
            Call {business.phone}
          </a>
          <a
            class="rounded-full border border-ink/20 px-6 py-3 text-sm font-semibold hover:border-ink"
            href="/#quote"
          >
            Request a quote
          </a>
        </div>
      </div>
    </div>
  </article>
</Layout>

<style is:global>
  .prose {
    --tw-prose-body: var(--color-ink-soft);
    --tw-prose-headings: var(--color-ink);
    --tw-prose-links: var(--color-ink);
    --tw-prose-bold: var(--color-ink);
    --tw-prose-bullets: var(--color-ink);
    --tw-prose-counters: var(--color-ink-soft);
    --tw-prose-hr: var(--color-border);
    --tw-prose-quotes: var(--color-ink);
    --tw-prose-quote-borders: var(--color-border);
    --tw-prose-code: var(--color-ink);
    --tw-prose-pre-code: var(--color-paper);
    --tw-prose-pre-bg: var(--color-ink);
  }

  .prose h2 {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .prose h3 {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .prose p {
    font-size: 1rem;
    line-height: 1.75;
    margin-bottom: 1.25rem;
  }

  .prose ul,
  .prose ol {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.5rem;
  }

  .prose a {
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .prose a:hover {
    opacity: 0.7;
  }

  .prose blockquote {
    border-left: 3px solid var(--color-border);
    padding-left: 1rem;
    font-style: italic;
    margin: 1.5rem 0;
  }

  .prose img {
    border-radius: 1rem;
    margin: 1.5rem 0;
  }
</style>
